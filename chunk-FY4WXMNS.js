import{a as d,b as f}from"./chunk-2XCPYOPQ.js";import{h as l,j as h,k as m,r as g}from"./chunk-RJ6X7B6G.js";import{a as u,b as w,j as s}from"./chunk-VI73JOY6.js";var v=(()=>{let i=class i{uploadImage(r,e,t){return s(this,null,function*(){let a=r.name.split(".").pop(),o=`${t}/${Math.random()}.${a}`,{error:c}=yield d.storage.from(e).upload(o,r,{cacheControl:"3600"});if(c)throw c;let{data:p}=d.storage.from(e).getPublicUrl(o);return p?.publicUrl??null})}deleteImage(r,e){return s(this,null,function*(){try{let{data:t,error:a}=yield d.storage.from(r).remove([e])}catch(t){console.error("Error deleting image:",t)}})}};i.\u0275fac=function(e){return new(e||i)},i.\u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"});let n=i;return n})();var S=(()=>{let i=class i{constructor(r,e){this.authService=r,this.storageService=e}addKid(r){return s(this,null,function*(){let e=yield this.authService.getSession();if(!e||!e.data||!e.data.session)throw new Error("User not authenticated");let t=e.data.session.user,a=null;r.profile_picture_file&&(a=yield this.storageService.uploadImage(r.profile_picture_file,"kid-profiles",t.id));let{data:o,error:c}=yield d.from("kids").insert({name:r.name,profile_picture_url:a,user_id:t.id}).select(`
        *,
        rewards (*)
      `);if(c)throw c;if(!o||o.length===0)throw new Error("Failed to create kid");return o[0]})}getKidsByUser(r){return s(this,null,function*(){let{data:e,error:t}=yield d.from("kids").select("*, rewards (*)").eq("user_id",r);if(t)throw t;return e||[]})}getKidById(r){return s(this,null,function*(){let{data:e,error:t}=yield d.from("kids").select("*").eq("id",r).single();if(t)throw t;return e})}updateKid(r,e){return s(this,null,function*(){let t=yield this.authService.getSession();if(!t||!t.data||!t.data.session)throw new Error("User not authenticated");let a=t.data.session.user,o=null;e&&(o=yield this.storageService.uploadImage(e,"kid-profiles",a.id));let{data:c,error:p}=yield d.from("kids").update({name:r.name,profile_picture_url:o??r.profile_picture_url}).eq("id",r.id).select();if(p)throw p;if(!c||c.length===0)throw new Error("Failed to create kid");return c[0]})}deleteKid(r){return s(this,null,function*(){if(r.profile_picture_url){let a=r.profile_picture_url.split("/"),o=`${a[a.length-2]}/${a[a.length-1]}`;yield this.storageService.deleteImage("kid-profiles",o)}let{error:e}=yield d.from("rewards").delete().eq("kid_id",r.id);if(e)throw e;let{error:t}=yield d.from("kids").delete().eq("id",r.id);if(t)throw t})}};i.\u0275fac=function(e){return new(e||i)(h(f),h(v))},i.\u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"});let n=i;return n})();var k=(()=>{let i=class i{constructor(r){this.authService=r}addReward(r){return s(this,null,function*(){let e=yield this.authService.getSession();if(!e?.data?.session?.user)throw new Error("User not authenticated");let t=e.data.session.user,{data:a,error:o}=yield d.from("rewards").insert(w(u({},r),{user_id:t.id})).select();if(o)throw o;if(!a||a.length===0)throw new Error("Failed to create reward");return a[0]})}getRewardsByKid(r){return s(this,null,function*(){let{data:e,error:t}=yield d.from("rewards").select("*").eq("kid_id",r).order("created_at",{ascending:!1});if(t)throw t;return e||[]})}};i.\u0275fac=function(e){return new(e||i)(h(f))},i.\u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"});let n=i;return n})();var N=(()=>{let i=class i{constructor(){this.kidsService=m(S),this.rewardService=m(k),this.authService=m(f),this.kids=g([]),this.loading=g(!1)}loadKids(){return s(this,null,function*(){this.loading.set(!0);try{let r=yield this.authService.getSession();if(!r?.data?.session?.user)return;let e=r.data.session.user,t=yield this.kidsService.getKidsByUser(e.id);this.kids.set(t)}catch(r){console.error("Error loading kids:",r)}finally{this.loading.set(!1)}})}addKid(r){return s(this,null,function*(){this.loading.set(!0);try{let e=yield this.kidsService.addKid(r);this.kids.update(t=>[...t,e])}catch(e){console.error("Error adding kid:",e)}finally{this.loading.set(!1)}})}updateKid(r,e){return s(this,null,function*(){this.loading.set(!0);try{let t=yield this.kidsService.updateKid(r,e);this.kids.update(a=>a.map(o=>o.id==r.id?u({},t):o))}catch(t){console.error("Error updating kid:",t)}finally{this.loading.set(!1)}})}deleteKid(r){return s(this,null,function*(){this.loading.set(!0);try{yield this.kidsService.deleteKid(r),this.kids.update(e=>e.filter(t=>t.id!=r.id))}catch(e){console.error("Error deleting kid:",e)}finally{this.loading.set(!1)}})}addReward(r){return s(this,null,function*(){try{let e=yield this.rewardService.addReward(r);console.log("newReward:",e),this.kids.update(t=>t.map(a=>a.id==r.kid_id?w(u({},a),{rewards:[...a.rewards,e]}):a)),console.log("kids",this.kids())}catch(e){console.error("Error adding reward:",e)}})}};i.\u0275fac=function(e){return new(e||i)},i.\u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"});let n=i;return n})();export{N as a};
