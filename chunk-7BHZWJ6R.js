import{a as g}from"./chunk-UQIJAAKI.js";import{a as d,b as f}from"./chunk-3ZBHH6HC.js";import{h as l,j as p,k as h,r as y}from"./chunk-LTL7P2HV.js";import{a as u,b as w,j as s}from"./chunk-VI73JOY6.js";var S=(()=>{let i=class i{constructor(){this.errorHandler=h(g)}uploadImage(e,r,t){return s(this,null,function*(){let a=e.name.split(".").pop(),o=`${t}/${Math.random()}.${a}`,{error:c}=yield d.storage.from(r).upload(o,e,{cacheControl:"3600"});if(c)throw c;let{data:m}=d.storage.from(r).getPublicUrl(o);return m?.publicUrl??null})}deleteImage(e,r){return s(this,null,function*(){try{let{data:t,error:a}=yield d.storage.from(e).remove([r])}catch(t){this.errorHandler.handleError(t)}})}};i.\u0275fac=function(r){return new(r||i)},i.\u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"});let n=i;return n})();var I=(()=>{let i=class i{constructor(e,r){this.authService=e,this.storageService=r}addKid(e){return s(this,null,function*(){let r=yield this.authService.getSession();if(!r||!r.data||!r.data.session)throw new Error("User not authenticated");let t=r.data.session.user,a=null;e.profile_picture_file&&(a=yield this.storageService.uploadImage(e.profile_picture_file,"kid-profiles",t.id));let{data:o,error:c}=yield d.from("kids").insert({name:e.name,profile_picture_url:a,user_id:t.id}).select(`
        *,
        rewards (*)
      `);if(c)throw c;if(!o||o.length===0)throw new Error("Failed to create kid");return o[0]})}getKidsByUser(e){return s(this,null,function*(){let{data:r,error:t}=yield d.from("kids").select("*, rewards (*)").eq("user_id",e);if(t)throw t;return r||[]})}getKidById(e){return s(this,null,function*(){let{data:r,error:t}=yield d.from("kids").select("*").eq("id",e).single();if(t)throw t;return r})}updateKid(e,r){return s(this,null,function*(){let t=yield this.authService.getSession();if(!t||!t.data||!t.data.session)throw new Error("User not authenticated");let a=t.data.session.user,o=null;r&&(o=yield this.storageService.uploadImage(r,"kid-profiles",a.id));let{data:c,error:m}=yield d.from("kids").update({name:e.name,profile_picture_url:o??e.profile_picture_url}).eq("id",e.id).select();if(m)throw m;if(!c||c.length===0)throw new Error("Failed to create kid");return c[0]})}deleteKid(e){return s(this,null,function*(){if(e.profile_picture_url){let a=e.profile_picture_url.split("/"),o=`${a[a.length-2]}/${a[a.length-1]}`;yield this.storageService.deleteImage("kid-profiles",o)}let{error:r}=yield d.from("rewards").delete().eq("kid_id",e.id);if(r)throw r;let{error:t}=yield d.from("kids").delete().eq("id",e.id);if(t)throw t})}};i.\u0275fac=function(r){return new(r||i)(p(f),p(S))},i.\u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"});let n=i;return n})();var k=(()=>{let i=class i{constructor(e){this.authService=e}addReward(e){return s(this,null,function*(){let r=yield this.authService.getSession();if(!r?.data?.session?.user)throw new Error("User not authenticated");let t=r.data.session.user,{data:a,error:o}=yield d.from("rewards").insert(w(u({},e),{user_id:t.id})).select();if(o)throw o;if(!a||a.length===0)throw new Error("Failed to create reward");return a[0]})}getRewardsByKid(e){return s(this,null,function*(){let{data:r,error:t}=yield d.from("rewards").select("*").eq("kid_id",e).order("created_at",{ascending:!1});if(t)throw t;return r||[]})}};i.\u0275fac=function(r){return new(r||i)(p(f))},i.\u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"});let n=i;return n})();var z=(()=>{let i=class i{constructor(){this.kidsService=h(I),this.rewardService=h(k),this.authService=h(f),this.errorHandler=h(g),this.kids=y([]),this.loading=y(!1)}loadKids(){return s(this,null,function*(){this.loading.set(!0);try{let e=yield this.authService.getSession();if(!e?.data?.session?.user)return;let r=e.data.session.user,t=yield this.kidsService.getKidsByUser(r.id);this.kids.set(t)}catch(e){this.errorHandler.handleError(e)}finally{this.loading.set(!1)}})}addKid(e){return s(this,null,function*(){this.loading.set(!0);try{let r=yield this.kidsService.addKid(e);this.kids.update(t=>[...t,r])}catch(r){this.errorHandler.handleError(r)}finally{this.loading.set(!1)}})}updateKid(e,r){return s(this,null,function*(){this.loading.set(!0);try{let t=yield this.kidsService.updateKid(e,r);this.kids.update(a=>a.map(o=>o.id==e.id?u({},t):o))}catch(t){this.errorHandler.handleError(t)}finally{this.loading.set(!1)}})}deleteKid(e){return s(this,null,function*(){this.loading.set(!0);try{yield this.kidsService.deleteKid(e),this.kids.update(r=>r.filter(t=>t.id!=e.id))}catch(r){this.errorHandler.handleError(r)}finally{this.loading.set(!1)}})}addReward(e){return s(this,null,function*(){try{let r=yield this.rewardService.addReward(e);this.kids.update(t=>t.map(a=>a.id==e.kid_id?w(u({},a),{rewards:[...a.rewards,r]}):a))}catch(r){this.errorHandler.handleError(r)}})}};i.\u0275fac=function(r){return new(r||i)},i.\u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"});let n=i;return n})();export{z as a};
